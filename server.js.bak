import express from "express";
import cors from "cors";
import dotenv from "dotenv";
import fs from "fs";
import path from "path";
import multer from "multer";

dotenv.config();

const app = express();
app.use(cors());
app.use(express.json());

const PORT = process.env.PORT || 3001;
const RECORDINGS_DIR = process.env.RECORDINGS_DIR || "./recordings";

// ×•×“× ×©×”×ª×™×§×™×™×” ×§×™×™×ž×ª
fs.mkdirSync(RECORDINGS_DIR, { recursive: true });

// ×‘×“×™×§×ª ×•×•×œ×™×•×/×›×ª×™×‘×”
try {
  const testFile = path.join(RECORDINGS_DIR, "_volume_check.txt");
  fs.writeFileSync(testFile, "âœ… Volume OK " + new Date().toISOString());
  console.log("âœ… Volume check: created", testFile);
} catch (err) {
  console.error("âŒ Volume check failed:", err.message);
}

// =============================
// ðŸ“¥ Multer diskStorage â‡’ ×©×•×ž×¨ ×™×©×™×¨×•×ª ×œ×ª×™×§×™×™×ª ×”×™×¢×“
// =============================
const storage = multer.diskStorage({
  destination: (req, file, cb) => cb(null, RECORDINGS_DIR),
  filename: (req, file, cb) => {
    const fallback = "recording_" + Date.now();
    const safe = (file.originalname || fallback).replace(/[^\w.\-]+/g, "_");
    cb(null, safe);
  },
});
const upload = multer({ storage });

// =============================
// ðŸ“¥ Upload route
// =============================
app.post("/api/upload", upload.single("file"), (req, res) => {
  try {
    // ×‘×©×™×ž×•×© ×‘-diskStorage ××™×Ÿ ×¦×•×¨×š ×‘-rename â€” ×”×§×•×‘×¥ ×›×‘×¨ ×‘×ª×™×§×™×™×” ×”×¡×•×¤×™×ª
    console.log("âœ… Uploaded recording saved:", req.file.path);
    res.json({ ok: true, name: path.basename(req.file.path) });
  } catch (err) {
    console.error("âŒ Upload save error:", err.message);
    res.status(500).json({ ok: false, error: err.message });
  }
});

// =============================
// ðŸŽ§ List recordings
// =============================
app.get("/api/recordings", (req, res) => {
  try {
    const files = fs.readdirSync(RECORDINGS_DIR).map((name) => {
      const stats = fs.statSync(path.join(RECORDINGS_DIR, name));
      return { name, size: stats.size, mtimeMs: stats.mtimeMs };
    });
    res.json(files);
  } catch (err) {
    res.status(500).json({ ok: false, error: err.message });
  }
});

// =============================
// ðŸ—‘ Delete file
// =============================
app.delete("/api/recordings/:name", (req, res) => {
  const filePath = path.join(RECORDINGS_DIR, req.params.name);
  try {
    fs.unlinkSync(filePath);
    console.log("ðŸ—‘ Deleted:", req.params.name);
    res.json({ ok: true });
  } catch (err) {
    console.error("âŒ Delete failed:", err.message);
    res.status(500).json({ ok: false, error: err.message });
  }
});

// =============================
// â–¶ï¸ Serve recordings inline (×œ× ×œ×”×•×¨×“×” ××•×˜×•×ž×˜×™×ª)
// =============================
app.get("/recordings/:name", (req, res) => {
  const filePath = path.join(RECORDINGS_DIR, req.params.name);
  if (!fs.existsSync(filePath)) return res.status(404).send("File not found");
  const ext = path.extname(filePath).toLowerCase();
  let mime = "application/octet-stream";
  if (ext === ".wav") mime = "audio/wav";
  else if (ext === ".mp3") mime = "audio/mpeg";
  else if (ext === ".mp4") mime = "video/mp4";
  res.setHeader("Content-Type", mime);
  res.setHeader("Content-Disposition", "inline");
  res.sendFile(path.resolve(filePath));
});

// =============================
// ðŸ©º Health
// =============================
app.get("/api/health", (req, res) => {
  res.json({ ok: true, dir: RECORDINGS_DIR, time: new Date().toISOString() });
});

app.listen(PORT, () => {
  console.log(`ðŸš€ Server running on port ${PORT}`);
});
